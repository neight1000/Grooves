<script>
const presetSettings = {
  plants: {
    scale: [174, 285, 396, 417, 528],
    color: "#00FF7F", // sea green
  },
  mold: {
    scale: [432, 639, 741],
    color: "#8A2BE2", // blue violet
  },
  bacteria: {
    scale: [528, 554, 585, 728],
    color: "#FF4500", // orange red
  },
  mushrooms: {
    scale: [417, 444, 528, 639],
    color: "#FFD700", // gold
  },
  harmony: {
    scale: [432, 528, 639, 741, 852],
    color: "#00FFFF", // cyan
  },
  "8A": { scale: [174, 220, 440], color: "#32CD32" },
  "8B": { scale: [261, 329, 528], color: "#FFFF00" },
  "9A": { scale: [196, 293, 440], color: "#00CED1" },
  "9B": { scale: [293, 392, 587], color: "#FFA500" }
};

function getScaleFromPreset(val) {
  const preset = presetSettings[val];
  return preset ? preset.scale : [174, 220, 261];
}

function getColorFromPreset(val) {
  const preset = presetSettings[val];
  return preset ? preset.color : "#FFFFFF";
}

document.getElementById('preset').addEventListener('change', () => {
  const selected = preset.value;
  currentWaveColor = getColorFromPreset(selected);
  if (!stopped) {
    scheduleNotes(getScaleFromPreset(selected));
  }
});
</script>
<script>
function playTone(freq) {
  const osc = audioCtx.createOscillator();
  osc.type = 'square';
  osc.frequency.value = freq;

  const gainNode = audioCtx.createGain();
  const now = audioCtx.currentTime;
  gainNode.gain.setValueAtTime(0, now);
  gainNode.gain.linearRampToValueAtTime(0.2, now + 0.5);
  gainNode.gain.linearRampToValueAtTime(0, now + 2.5);

  const delayNode = audioCtx.createDelay();
  delayNode.delayTime.value = parseFloat(delay.value);
  const feedbackNode = audioCtx.createGain();
  feedbackNode.gain.value = parseFloat(echo.value);

  const filterNode = audioCtx.createBiquadFilter();
  filterNode.type = "lowpass";
  filterNode.frequency.value = parseFloat(filter.value);

  osc.connect(gainNode);
  gainNode.connect(filterNode);
  filterNode.connect(delayNode);
  delayNode.connect(feedbackNode);
  feedbackNode.connect(delayNode);
  delayNode.connect(reverbNode);
  gainNode.connect(analyser);

  osc.start(now);
  osc.stop(now + 2.5);
}

function scheduleNotes(scale) {
  clearInterval(bpmTimer);
  bpmTimer = setInterval(() => {
    if (!stopped) {
      const freq = scale[Math.floor(Math.random() * scale.length)];
      playTone(freq);
    }
  }, 60000 / bpm);
}

function animate() {
  requestAnimationFrame(animate);
  if (!analyser) return;

  analyser.getByteTimeDomainData(dataArray);
  ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  if (trailFrames.length > 12) trailFrames.shift();
  trailFrames.push([...dataArray]);

  for (let t = 0; t < trailFrames.length; t++) {
    const data = trailFrames[t];
    const slice = canvas.width / data.length;
    ctx.beginPath();
    let x = 0;
    for (let i = 0; i < data.length; i++) {
      const v = (data[i] - 128) / 128.0;
      const y = (v * canvas.height / 1.8) + canvas.height / 2;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
      x += slice;
    }
    const alpha = 0.05 + (t / trailFrames.length) * 0.1;
    ctx.strokeStyle = currentWaveColor;
    ctx.globalAlpha = alpha;
    ctx.shadowBlur = 16;
    ctx.shadowColor = currentWaveColor;
    ctx.stroke();
    ctx.shadowBlur = 0;
    ctx.globalAlpha = 1.0;
  }
}
</script>
<script>
document.getElementById('play').addEventListener('click', () => {
  initAudio();
  stopped = false;
  const scale = getScaleFromPreset(preset.value);
  currentWaveColor = getColorFromPreset(preset.value);
  scheduleNotes(scale);
});

document.getElementById('stop').addEventListener('click', () => {
  stopped = true;
  clearInterval(bpmTimer);
});

document.getElementById('bpm').addEventListener('input', e => {
  bpm = parseInt(e.target.value);
  if (!stopped) {
    const scale = getScaleFromPreset(preset.value);
    scheduleNotes(scale);
  }
});
</script>
</body>
</html>
