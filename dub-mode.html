<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plantasia App v3</title>
  <style>
    html, body {
      margin: 0;
      background: black;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
    }
    canvas {
      display: block;
      width: 100vw;
      height: 60vh;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px;
      background: black;
      position: fixed;
      bottom: 0;
      width: 100%;
      box-sizing: border-box;
    }
    label {
      font-size: 0.8em;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    input[type=range], select {
      width: 100px;
    }
    button {
      background: white;
      color: black;
      font-weight: bold;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
    }
    #camelotKey {
      font-size: 1em;
    }
  </style>
</head>
<body>
  <canvas id="visualizer"></canvas>
  <div id="controls">
    <button id="play">Play</button>
    <button id="stop">Stop</button>
    <label>Preset
      <select id="preset">
        <option value="plants">üåø Plants</option>
        <option value="mold">üß´ Mold</option>
        <option value="bacteria">ü¶† Bacteria</option>
        <option value="mushrooms">üçÑ Mushrooms</option>
        <option value="roots">üå± Roots</option>
      </select>
    </label>
    <label>Volume<input type="range" id="volume" min="0" max="1" step="0.01" value="0.5"></label>
    <label>BPM<input type="range" id="bpm" min="50" max="130" step="1" value="80"></label>
    <label>Delay<input type="range" id="delay" min="0" max="1" step="0.01" value="0.3"></label>
    <label>Echo<input type="range" id="echo" min="0" max="1" step="0.01" value="0.4"></label>
    <label>Filter<input type="range" id="filter" min="200" max="12000" step="10" value="800"></label>
    <label>Frequency<input type="range" id="frequency" min="50" max="400" step="1" value="220"></label>
    <label>Oscillations<input type="range" id="osc" min="1" max="10" step="1" value="3"></label>
    <span id="camelotKey">Key: --</span>
  </div>

  <script>
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight * 0.6;

    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    const dataArray = new Uint8Array(analyser.frequencyBinCount);

    const filter = audioCtx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 800;

    const delayNode = audioCtx.createDelay();
    delayNode.delayTime.value = 0.3;

    const feedbackGain = audioCtx.createGain();
    feedbackGain.gain.value = 0.4;
    delayNode.connect(feedbackGain).connect(delayNode);

    const masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.5;

    feedbackGain.connect(filter);
    filter.connect(masterGain);
    masterGain.connect(analyser).connect(audioCtx.destination);

    let oscillators = [];
    let playing = false;

    const plantScale = [220, 246.94, 293.66, 329.63, 392];
    const camelotMap = {
      220: '8A',
      246.94: '9A',
      293.66: '10A',
      329.63: '11A',
      392: '12A'
    };

    function getDetunedFrequencies(baseFreq, count) {
      let freqs = [];
      let spread = 5;
      for (let i = 0; i < count; i++) {
        let offset = ((i - (count - 1) / 2) / (count - 1)) * spread;
        freqs.push(baseFreq + offset);
      }
      return freqs;
    }

    function playTones() {
      stopTones();
      const baseFreq = parseFloat(document.getElementById('frequency').value);
      const oscCount = parseInt(document.getElementById('osc').value);
      const freqs = getDetunedFrequencies(baseFreq, oscCount);
      freqs.forEach(freq => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(delayNode);
        gain.connect(filter);

        // envelope
        const attack = 1.5;
        const release = 2;
        gain.gain.setValueAtTime(0, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0.2 / oscCount, audioCtx.currentTime + attack);
        gain.gain.setTargetAtTime(0, audioCtx.currentTime + attack, release);

        osc.start();
        oscillators.push({ osc, gain });
      });
      updateKeyLabel(baseFreq);
      playing = true;
    }

    function stopTones() {
      oscillators.forEach(({ osc, gain }) => {
        osc.stop();
        osc.disconnect();
        gain.disconnect();
      });
      oscillators = [];
      playing = false;
      document.getElementById('camelotKey').textContent = 'Key: --';
    }

    function updateKeyLabel(freq) {
      let closest = plantScale.reduce((a, b) =>
        Math.abs(b - freq) < Math.abs(a - freq) ? b : a
      );
      document.getElementById('camelotKey').textContent = `Key: ${camelotMap[closest] || '--'}`;
    }

    function draw() {
      requestAnimationFrame(draw);
      analyser.getByteTimeDomainData(dataArray);
      ctx.fillStyle = 'rgba(0,0,0,0.25)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      ctx.lineWidth = 2;
      const freq = parseFloat(document.getElementById('frequency').value);
      const hue = (freq - 50) / 350 * 360;
      ctx.strokeStyle = `hsl(${hue}, 100%, 70%)`;
      const sliceWidth = canvas.width / dataArray.length;
      let x = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0;
        const y = (v * canvas.height) / 2;
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
        x += sliceWidth;
      }
      ctx.stroke();
    }

    draw();

    document.getElementById('play').onclick = async () => {
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      playTones();
    };

    document.getElementById('stop').onclick = stopTones;

    document.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('input', () => {
        if (el.id === 'volume') masterGain.gain.value = parseFloat(el.value);
        if (el.id === 'delay') delayNode.delayTime.value = parseFloat(el.value);
        if (el.id === 'echo') feedbackGain.gain.value = parseFloat(el.value);
        if (el.id === 'filter') filter.frequency.value = parseFloat(el.value);
        if (el.id === 'frequency') if (playing) playTones();
        if (el.id === 'osc') if (playing) playTones();
        if (el.id === 'preset') {
          const preset = el.value;
          const baseMap = {
            plants: 220,
            mold: 246.94,
            bacteria: 293.66,
            mushrooms: 329.63,
            roots: 392
          };
          document.getElementById('frequency').value = baseMap[preset];
          if (playing) playTones();
        }
      });
    });
  </script>
</body>
</html>
