<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plantasia App – Fixed Visualizer + Reverb</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      color: white;
      font-family: monospace;
      overflow: hidden;
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
    }
    .ui {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.85);
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      z-index: 1;
    }
    .ui label {
      font-size: 10px;
      display: block;
      text-align: center;
    }
    .ui input[type="range"], .ui select {
      width: 90px;
    }
    .ui button {
      font-size: 12px;
      padding: 4px 8px;
      background: transparent;
      border: 1px solid white;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
<canvas id="waveCanvas"></canvas>
<div class="ui">
  <div><label>Preset</label>
    <select id="preset">
      <option value="plants">Plants</option>
      <option value="mold">Mold</option>
      <option value="bacteria">Bacteria</option>
      <option value="mushrooms">Mushrooms</option>
      <option value="harmony">Lifeform Harmony</option>
      <option value="8A">8A – A minor</option>
      <option value="8B">8B – C major</option>
      <option value="9A">9A – E minor</option>
      <option value="9B">9B – G major</option>
    </select>
  </div>
  <div><label>Delay</label><input type="range" id="delay" min="0.01" max="2.0" step="0.01" value="0.8" /></div>
  <div><label>Echo</label><input type="range" id="echo" min="0" max="1.0" step="0.01" value="0.6" /></div>
  <div><label>Filter</label><input type="range" id="filter" min="100" max="8000" step="10" value="1000" /></div>
  <div><label>Frequency</label><input type="range" id="freq" min="50" max="1000" step="1" value="174" /></div>
  <div><label>Volume</label><input type="range" id="volume" min="0" max="100" value="60" /></div>
  <div><label>BPM</label><input type="range" id="bpm" min="40" max="180" value="90" /></div>
  <button id="play">PLAY</button>
  <button id="stop">STOP</button>
</div>
<script>
let audioCtx, analyser, masterGain, reverbNode, bufferLength, dataArray;
let bpm = 90, bpmTimer = null, stopped = true;
let trailFrames = [], currentWaveColor = "#FFFFFF";
let canvas, ctx;

const presetSettings = {
  plants: {
    scale: [174, 285, 396, 417, 528],
    color: "#00FF7F",
    delay: 0.6,
    echo: 0.4,
    filter: 1200,
    volume: 60,
    freq: 174
  },
  mold: {
    scale: [432, 639, 741],
    color: "#8A2BE2",
    delay: 0.4,
    echo: 0.5,
    filter: 1000,
    volume: 50,
    freq: 432
  },
  bacteria: {
    scale: [528, 554, 585, 728],
    color: "#FF4500",
    delay: 0.5,
    echo: 0.6,
    filter: 900,
    volume: 55,
    freq: 528
  },
  mushrooms: {
    scale: [417, 444, 528, 639],
    color: "#FFD700",
    delay: 0.7,
    echo: 0.5,
    filter: 1100,
    volume: 65,
    freq: 417
  },
  harmony: {
    scale: [432, 528, 639, 741, 852],
    color: "#00FFFF",
    delay: 0.6,
    echo: 0.5,
    filter: 1400,
    volume: 70,
    freq: 528
  },
  "8A": {
    scale: [174, 220, 440],
    color: "#32CD32",
    delay: 0.5,
    echo: 0.4,
    filter: 800,
    volume: 60,
    freq: 174
  },
  "8B": {
    scale: [261, 329, 528],
    color: "#FFFF00",
    delay: 0.6,
    echo: 0.5,
    filter: 950,
    volume: 65,
    freq: 261
  },
  "9A": {
    scale: [196, 293, 440],
    color: "#00CED1",
    delay: 0.4,
    echo: 0.4,
    filter: 1000,
    volume: 55,
    freq: 196
  },
  "9B": {
    scale: [293, 392, 587],
    color: "#FFA500",
    delay: 0.6,
    echo: 0.5,
    filter: 1200,
    volume: 60,
    freq: 293
  }
};

function getScaleFromPreset(val) {
  const preset = presetSettings[val];
  return preset ? preset.scale : [174, 220, 261];
}

function getColorFromPreset(val) {
  const preset = presetSettings[val];
  return preset ? preset.color : "#FFFFFF";
}

function updateSlidersFromPreset(val) {
  const preset = presetSettings[val];
  if (!preset) return;
  document.getElementById('delay').value = preset.delay;
  document.getElementById('echo').value = preset.echo;
  document.getElementById('filter').value = preset.filter;
  document.getElementById('volume').value = preset.volume;
  document.getElementById('freq').value = preset.freq;
}

// Triggered on preset change
document.getElementById('preset').addEventListener('change', () => {
  const selected = preset.value;
  currentWaveColor = getColorFromPreset(selected);
  updateSlidersFromPreset(selected);
  if (!stopped) {
    scheduleNotes(getScaleFromPreset(selected));
  }
});
</script>

</body>
</html>
