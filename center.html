<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plantasia App v53 â€“ Fixed Playback</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');
    :root { --bg: #000; --fg: #fff; --font: 'Roboto Mono', monospace; --accent: #00ff00; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--font); background: var(--bg); color: var(--fg); overflow: hidden; }
    h1 { text-align: center; margin: 1rem 0; font-size: 1.5rem; }
    #uiPanel { position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem; z-index: 3; }
    button, select, input[type="range"] {
      background: transparent; color: var(--fg); border: 1px solid var(--fg);
      padding: 0.5rem 1rem; font-size: 0.9rem; text-transform: uppercase; font-family: var(--font);
    }
    button:hover { background: var(--fg); color: var(--bg); cursor: pointer; }
    input[type="range"] {
      -webkit-appearance: none; width: 150px; height: 1px; background: var(--fg); margin: 0.5rem 0;
    }
    input[type="range"]::-webkit-slider-runnable-track { width:100%; height:1px; background:var(--fg); }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance:none; width:24px; height:24px; background:var(--accent);
      border-radius:50%; margin-top:-11px; cursor:pointer;
    }
    label { font-size:0.75rem; text-transform: uppercase; display:flex; flex-direction:column; align-items:center; gap:0.25rem; }
    #controlsWrapper {
      position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%);
      display: none; background: rgba(0,0,0,0.85); padding: 0.5rem; border: 1px solid var(--fg); z-index:3;
    }
    .controls { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    #visualizer { position:absolute; top:0; left:0; width:100vw; height:100vh; background:var(--bg); z-index:1; }
    #infoDisplay { position:absolute; top:1rem; left:1rem; background:rgba(0,0,0,0.6); padding:0.5rem; white-space:pre; display:none; z-index:3; }
    canvas { display: block; }
  </style>
</head>
<body>
  <h1>PLANTASIA APP</h1>
  <div id="uiPanel">
    <button id="toggleUI">Show Controls</button>
    <button id="toggleData">Show Data</button>
    <button id="play">Play</button>
    <button id="stop">Stop</button>
  </div>
  <div id="controlsWrapper" class="controls">
    <label>Preset
      <select id="preset">
        <option value="plants">Plants</option>
        <option value="mold">Mold</option>
        <option value="bacteria">Bacteria</option>
        <option value="mushrooms">Mushrooms</option>
        <option value="harmony">Lifeform Harmony</option>
        <option value="euclid">Euclidean Rhythm</option>
        <option value="fib">Fibonacci Intervals</option>
        <option value="markov">Markov Chain</option>
        <option value="raga">Raga</option>
        <option value="hijaz">Hijaz</option>
        <option value="pelog">Pelog</option>
        <option value="insen">In-Sen</option>
        <option value="bachPreludeC">Bach Prelude</option>
        <option value="planetRock">Planet Rock</option>
      </select>
    </label>
    <label>Delay <input type="range" id="delay" min="0.01" max="2" step="0.01" value="1.2"/></label>
    <label>Echo <input type="range" id="echo" min="0" max="0.5" step="0.01" value="0.2"/></label>
    <label>Reverb <input type="range" id="reverb" min="0" max="1" step="0.01" value="0.5"/></label>
    <label>Filter <input type="range" id="filter" min="100" max="8000" step="10" value="1800"/></label>
    <label>Freq <input type="range" id="freq" min="20" max="500" step="1" value="200"/></label>
    <label>Vol <input type="range" id="volume" min="0" max="100" step="1" value="40"/></label>
    <label>BPM <input type="range" id="bpm" min="64" max="130" step="1" value="90"/></label>
    <label>Density <input type="range" id="density" min="1" max="10" step="1" value="3"/></label>
  </div>
  <canvas id="visualizer"></canvas>
  <div id="infoDisplay"></div>
  <script>
    // Setup
    let audioCtx, analyser, masterGain, bufferLength, dataArray, bpmTimer, stopped=true;
    let trail = []; const MAX_LAYERS = 6;
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    const ui = {
      play: document.getElementById('play'),
      stop: document.getElementById('stop'),
      toggleUI: document.getElementById('toggleUI'),
      toggleData: document.getElementById('toggleData'),
      controls: document.getElementById('controlsWrapper'),
      info: document.getElementById('infoDisplay')
    };
    const controls = {
      preset: document.getElementById('preset'),
      delay: document.getElementById('delay'),
      echo: document.getElementById('echo'),
      reverb: document.getElementById('reverb'),
      filter: document.getElementById('filter'),
      freq: document.getElementById('freq'),
      volume: document.getElementById('volume'),
      bpm: document.getElementById('bpm'),
      density: document.getElementById('density')
    };

    function initAudio() {
      if (audioCtx) return;
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);
      masterGain = audioCtx.createGain();
      masterGain.gain.value = parseFloat(controls.volume.value)/100;
      masterGain.connect(audioCtx.destination);
      // Pre-fill trail
      for (let i=0; i<MAX_LAYERS; i++) trail.push(new Uint8Array(bufferLength));
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
    }

    function resizeCanvas(){
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    function playTone() {
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      osc.type = 'square';
      osc.frequency.setValueAtTime(parseFloat(controls.freq.value), now);
      const gainNode = audioCtx.createGain();
      gainNode.gain.setValueAtTime(0, now);
      gainNode.gain.linearRampToValueAtTime(0.3, now+0.1);
      gainNode.gain.linearRampToValueAtTime(0, now+2);
      osc.connect(gainNode).connect(masterGain);
      osc.start(now); osc.stop(now+2);
    }

    function schedule() {
      clearInterval(bpmTimer);
      const interval = 60000/parseInt(controls.bpm.value,10);
      bpmTimer = setInterval(()=>{
        if (!stopped) playTone();
      }, interval);
    }

    function animate() {
      requestAnimationFrame(animate);
      if (!analyser) return;
      analyser.getByteTimeDomainData(dataArray);
      trail.shift();
      trail.push(dataArray.slice());
      ctx.fillStyle = 'rgba(0,0,0,0.1)';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      const maxSize = Math.min(canvas.width, canvas.height) * 0.3;
      for (let i=0; i<trail.length; i++) {
        const layer = trail[i];
        const alpha = (i+1)/trail.length * 0.5;
        const size = maxSize * ((i+1)/trail.length);
        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);
        // Draw triangle
        const h = size * Math.sqrt(3)/2;
        ctx.beginPath();
        ctx.moveTo(0, -h);
        ctx.lineTo(-size/2, h/3);
        ctx.lineTo(size/2, h/3);
        ctx.closePath();
        ctx.strokeStyle = 'rgba(0,255,0,'+alpha+')';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.restore();
      }
      // preset title
      ctx.font = '12pt Roboto Mono';
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.fillText(controls.preset.options[controls.preset.selectedIndex].text, canvas.width/2, 40);
    }

    // Event bindings
    ui.play.addEventListener('click', async ()=>{
      initAudio();
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      stopped = false;
      schedule();
    });
    ui.stop.addEventListener('click', ()=>{
      stopped = true;
      clearInterval(bpmTimer);
    });
    ui.toggleUI.addEventListener('click', ()=>{
      const vis = ui.controls.style.display !== 'block';
      ui.controls.style.display = vis ? 'block':'none';
      ui.toggleUI.textContent = vis?'Hide Controls':'Show Controls';
    });
    ui.toggleData.addEventListener('click', ()=>{
      const vis = ui.info.style.display !== 'block';
      ui.info.style.display = vis?'block':'none';
      ui.toggleData.textContent = vis?'Hide Data':'Show Data';
    });
    // Display values
    setInterval(() => {
      ui.info.textContent =
      `PRESET: ${controls.preset.value}\nDELAY: ${controls.delay.value}\nECHO: ${controls.echo.value}\nREVERB: ${controls.reverb.value}\nFILTER: ${controls.filter.value}\nFREQ: ${controls.freq.value}\nVOL: ${controls.volume.value}\nBPM: ${controls.bpm.value}\nDENSITY: ${controls.density.value}`;
    }, 250);

    animate();
  </script>
</body>
</html>
